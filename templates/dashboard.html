<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <title>Unified Trading Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #07070b;
      --bg-elev-1: rgba(255, 255, 255, 0.035);
      --bg-elev-2: rgba(255, 255, 255, 0.06);
      --bg-elev-3: rgba(255, 255, 255, 0.085);
      --stroke: rgba(255, 255, 255, 0.08);
      --stroke-strong: rgba(255, 255, 255, 0.12);

      --text: rgba(255, 255, 255, 0.95);
      --muted: rgba(255, 255, 255, 0.55);
      --faint: rgba(255, 255, 255, 0.38);

      --good: #20f5a6;
      --bad: #ff4d67;
      --warn: #ffcc66;
      --info: #5aa6ff;

      --crypto: #f7931a;
      --stocks: #00d4aa;

      --shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
      --radius-xl: 18px;
      --radius-lg: 14px;
      --radius-md: 12px;
      --radius-sm: 10px;

      --mono: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: 'Outfit', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(90, 166, 255, 0.18), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(32, 245, 166, 0.14), transparent 60%),
        radial-gradient(1100px 700px at 55% 95%, rgba(247, 147, 26, 0.12), transparent 65%);
      opacity: 0.9;
    }

    .container {
      max-width: 1320px;
      margin: 0 auto;
      padding: 26px 18px 40px;
    }

    .card {
      border: 1px solid var(--stroke);
      border-radius: var(--radius-xl);
      background: linear-gradient(180deg, var(--bg-elev-2), var(--bg-elev-1));
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(10px);
    }

    /* Topbar */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
      padding: 18px;
      position: sticky;
      top: 14px;
      z-index: 20;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 260px;
    }

    .brand-title {
      font-size: 1.15rem;
      letter-spacing: 0.2px;
      font-weight: 800;
    }

    .brand-subtitle {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .topbar-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex: 1;
      min-width: 240px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0, 0, 0, 0.25);
      color: var(--muted);
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .pill strong {
      color: var(--text);
      font-weight: 700;
      font-family: var(--mono);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(32, 245, 166, 0.12);
    }

    .dot.stale {
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(255, 77, 103, 0.14);
    }

    .topbar-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      appearance: none;
      border: 1px solid var(--stroke);
      background: rgba(0, 0, 0, 0.28);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease;
      display: inline-flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      border-color: var(--stroke-strong);
      background: rgba(255, 255, 255, 0.06);
    }

    .btn:active { transform: translateY(0px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

    .btn-primary {
      border-color: rgba(90, 166, 255, 0.35);
      background: linear-gradient(135deg, rgba(90, 166, 255, 0.25), rgba(99, 102, 241, 0.18));
    }

    .btn-danger {
      border-color: rgba(255, 77, 103, 0.35);
      background: linear-gradient(135deg, rgba(255, 77, 103, 0.22), rgba(255, 107, 107, 0.14));
    }

    .btn-ghost {
      border-color: transparent;
      background: transparent;
      color: var(--muted);
    }

    .btn-ghost:hover {
      border-color: var(--stroke);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }

    /* Summary */
    .summary-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin: 18px 0;
    }

    .summary-card {
      padding: 16px;
      position: relative;
      overflow: hidden;
    }

    .summary-card::before {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(700px 180px at 10% 10%, rgba(255, 255, 255, 0.12), transparent 70%);
      opacity: 0.6;
      pointer-events: none;
    }

    .summary-card.crypto { border-left: 3px solid rgba(247, 147, 26, 0.85); }
    .summary-card.stocks { border-left: 3px solid rgba(0, 212, 170, 0.85); }
    .summary-card.combined { border-left: 3px solid rgba(90, 166, 255, 0.85); }

    .summary-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .summary-value {
      font-family: var(--mono);
      font-weight: 900;
      font-size: 1.35rem;
      margin-top: 10px;
    }

    .summary-pnl {
      font-family: var(--mono);
      font-size: 0.92rem;
      margin-top: 6px;
      color: var(--muted);
    }

    .positive { color: var(--good) !important; }
    .negative { color: var(--bad) !important; }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 18px 0 18px;
    }

    .tab {
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.04);
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      transition: background 0.12s ease, border-color 0.12s ease, color 0.12s ease, transform 0.12s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.06);
      border-color: var(--stroke-strong);
    }

    .tab.active {
      color: var(--text);
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.16);
    }

    .tab.active.crypto { box-shadow: 0 0 0 3px rgba(247, 147, 26, 0.14); }
    .tab.active.stocks { box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.14); }

    /* Banner */
    .health-banner {
      margin: 12px 0 16px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 77, 103, 0.35);
      background: rgba(255, 77, 103, 0.10);
      color: rgba(255, 255, 255, 0.88);
      display: none;
    }

    .health-banner.show { display: block; }

    /* Content */
    .content { display: none; }
    .content.active { display: block; }

    /* Metrics */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .metric-card {
      padding: 14px;
    }

    .metric-label {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .metric-value {
      margin-top: 10px;
      font-family: var(--mono);
      font-size: 1.35rem;
      font-weight: 900;
    }

    /* Sections */
    .grid-2 {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      margin-bottom: 14px;
    }

    .section {
      padding: 16px;
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 0.98rem;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .section-title small {
      color: var(--muted);
      font-weight: 700;
      font-size: 0.82rem;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input, .select {
      border: 1px solid var(--stroke);
      background: rgba(0, 0, 0, 0.28);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.12s ease, background 0.12s ease;
      font-family: var(--sans);
    }

    .input::placeholder { color: var(--faint); }

    .input:focus, .select:focus {
      border-color: rgba(90, 166, 255, 0.35);
      background: rgba(255, 255, 255, 0.06);
    }

    /* Lists */
    .list-item {
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(0, 0, 0, 0.18);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
    }

    .list-item:hover {
      border-color: rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
    }

    .item-pair {
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.06);
      color: var(--muted);
      font-size: 0.78rem;
      font-weight: 800;
      white-space: nowrap;
    }

    .badge.buy { border-color: rgba(32, 245, 166, 0.24); color: var(--good); background: rgba(32, 245, 166, 0.08); }
    .badge.sell { border-color: rgba(255, 77, 103, 0.24); color: var(--bad); background: rgba(255, 77, 103, 0.08); }
    .badge.hold { border-color: rgba(168, 85, 247, 0.24); color: #c4a0ff; background: rgba(168, 85, 247, 0.10); }
    .badge.neutral { border-color: rgba(255, 255, 255, 0.12); color: var(--muted); }
    .badge.blocked { border-color: rgba(255, 204, 102, 0.28); color: var(--warn); background: rgba(255, 204, 102, 0.10); }

    .item-value {
      font-family: var(--mono);
      text-align: right;
      font-weight: 900;
    }

    .subtext {
      margin-top: 4px;
      color: var(--muted);
      font-size: 0.82rem;
    }

    /* Signals */
    .signals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }

    .signal-card {
      border: 1px solid rgba(255, 255, 255, 0.07);
      background: rgba(0, 0, 0, 0.18);
      border-radius: 16px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .signal-head {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 10px;
    }

    .signal-pair {
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .signal-method {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .signal-zscore {
      font-family: var(--mono);
      font-size: 1.25rem;
      font-weight: 900;
    }

    .signal-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 18px 14px;
      color: var(--muted);
      border: 1px dashed rgba(255, 255, 255, 0.14);
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.18);
    }

    /* Chart */
    #zscore-chart { border-radius: var(--radius-xl) !important; overflow: hidden; }

    /* Toast */
    .toast-stack {
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 999;
      display: grid;
      gap: 10px;
      width: min(420px, calc(100vw - 36px));
    }

    .toast {
      border: 1px solid var(--stroke);
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: start;
    }

    .toast .title {
      font-weight: 900;
      font-size: 0.92rem;
    }

    .toast .msg {
      color: var(--muted);
      margin-top: 4px;
      font-size: 0.86rem;
    }

    .toast .x {
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      color: var(--text);
      font-weight: 800;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 18px 12px;
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 16px;
    }

    /* Responsive */
    @media (max-width: 1100px) {
      .metrics-grid { grid-template-columns: repeat(3, 1fr); }
      .grid-2 { grid-template-columns: 1fr; }
      .topbar { position: relative; top: 0; }
    }

    @media (max-width: 780px) {
      .summary-bar { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .topbar { flex-direction: column; align-items: stretch; }
      .topbar-actions { justify-content: flex-start; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { scroll-behavior: auto !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <div class="toast-stack" id="toast-stack" aria-live="polite" aria-atomic="true"></div>

  <div class="container">
    <header class="topbar card">
      <div class="brand">
        <div class="brand-title">Unified Trading Dashboard</div>
        <div class="brand-subtitle">Crypto (Cointegration) + Stocks (Kalman Filter) ‚Ä¢ Paper Trading</div>
      </div>

      <div class="topbar-meta">
        <div class="pill" title="Current tab status">
          <span class="dot" id="global-status-dot"></span>
          <span id="global-status-text">Live</span>
        </div>
        <div class="pill" title="Last update time">
          <span style="color: var(--faint);">Last</span>
          <strong id="global-last-update">--</strong>
        </div>
        <div class="pill" title="Active tab">
          <span style="color: var(--faint);">Market</span>
          <strong id="global-market">CRYPTO</strong>
        </div>
      </div>

      <div class="topbar-actions">
        <button class="btn btn-primary" id="btn-force" onclick="forceUpdate()">üîÑ Force Update</button>
        <button class="btn btn-danger" id="btn-reset" onclick="resetPortfolio()">üóëÔ∏è Reset</button>
        <button class="btn btn-ghost" id="btn-refresh-pairs" onclick="refreshPairs()" title="Refresh stock pairs (runs in background)">üß¨ Refresh Pairs</button>
      </div>
    </header>

    <div class="summary-bar">
      <div class="summary-card crypto card">
        <div class="summary-label">‚Çø Crypto Portfolio</div>
        <div class="summary-value" id="crypto-value">$10,000</div>
        <div class="summary-pnl" id="crypto-pnl">+$0.00 (0.00%)</div>
      </div>

      <div class="summary-card stocks card">
        <div class="summary-label">üìà Stocks Portfolio</div>
        <div class="summary-value" id="stocks-value">$10,000</div>
        <div class="summary-pnl" id="stocks-pnl">+$0.00 (0.00%)</div>
      </div>

      <div class="summary-card combined card">
        <div class="summary-label">üí∞ Combined Total</div>
        <div class="summary-value" id="combined-value">$20,000</div>
        <div class="summary-pnl" id="combined-pnl">+$0.00 (0.00%)</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active crypto" type="button" data-market="crypto" onclick="switchTab('crypto')">‚Çø Crypto</button>
      <button class="tab stocks" type="button" data-market="stocks" onclick="switchTab('stocks')">üìà Stocks</button>
    </div>

    <div class="health-banner" id="health-banner">
      <strong style="color: var(--bad);">Data is stale.</strong>
      Last update was <span id="stale-time">--</span> ago. Try ‚ÄúForce Update‚Äù.
    </div>

    <!-- Crypto Content -->
    <section class="content active" id="content-crypto">
      <div class="metrics-grid">
        <div class="metric-card card">
          <div class="metric-label">TOTAL VALUE</div>
          <div class="metric-value" id="crypto-total">$10,000</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">CASH</div>
          <div class="metric-value" id="crypto-cash" style="color: var(--good);">$10,000</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">P&amp;L</div>
          <div class="metric-value" id="crypto-pnl-detail">$0.00</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">WIN RATE</div>
          <div class="metric-value" id="crypto-winrate">0%</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">COMPLETED</div>
          <div class="metric-value" id="crypto-trades">0</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="section card">
          <div class="section-title">
            <span>üìç Open Positions</span>
            <small id="crypto-positions-count">0</small>
          </div>
          <div id="crypto-positions"><div class="empty-state">No open positions</div></div>
        </div>

        <div class="section card">
          <div class="section-title">
            <span>üìú Recent Trades</span>
            <small>Last 5</small>
          </div>
          <div id="crypto-trades-list"><div class="empty-state">No trades yet</div></div>
        </div>
      </div>

      <div class="section card">
        <div class="section-title">
          <span>üì° Live Signals</span>
          <div class="toolbar">
            <input class="input" id="crypto-signal-search" placeholder="Search pair (e.g., BTC-ETH)" oninput="renderSignals('crypto')" />
            <select class="select" id="crypto-signal-sort" onchange="renderSignals('crypto')">
              <option value="absz">Sort: |Z|</option>
              <option value="pair">Sort: Pair</option>
              <option value="action">Sort: Action</option>
            </select>
          </div>
        </div>
        <div class="signals-grid" id="crypto-signals"></div>
      </div>

      <div class="toolbar" style="justify-content: center; margin-top: 12px;">
        <span class="pill"><span class="dot" id="crypto-status-dot"></span><span id="crypto-status">Live</span></span>
        <span class="pill">üîÑ Last: <strong id="crypto-last-update">--</strong></span>
      </div>
    </section>

    <!-- Stocks Content -->
    <section class="content" id="content-stocks">
      <div class="metrics-grid">
        <div class="metric-card card">
          <div class="metric-label">TOTAL VALUE</div>
          <div class="metric-value" id="stocks-total">$10,000</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">CASH</div>
          <div class="metric-value" id="stocks-cash" style="color: var(--good);">$10,000</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">P&amp;L</div>
          <div class="metric-value" id="stocks-pnl-detail">$0.00</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">WIN RATE</div>
          <div class="metric-value" id="stocks-winrate">0%</div>
        </div>
        <div class="metric-card card">
          <div class="metric-label">COMPLETED</div>
          <div class="metric-value" id="stocks-trades">0</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="section card">
          <div class="section-title">
            <span>üìç Open Positions</span>
            <small id="stocks-positions-count">0</small>
          </div>
          <div id="stocks-positions"><div class="empty-state">No open positions</div></div>
        </div>

        <div class="section card">
          <div class="section-title">
            <span>üìú Recent Trades</span>
            <small>Last 5</small>
          </div>
          <div id="stocks-trades-list"><div class="empty-state">No trades yet</div></div>
        </div>
      </div>

      <div class="section card">
        <div class="section-title">
          <span>üì° Live Signals</span>
          <div class="toolbar">
            <input class="input" id="stocks-signal-search" placeholder="Search pair (e.g., AAPL-MSFT)" oninput="renderSignals('stocks')" />
            <select class="select" id="stocks-signal-sort" onchange="renderSignals('stocks')">
              <option value="absz">Sort: |Z|</option>
              <option value="pair">Sort: Pair</option>
              <option value="action">Sort: Action</option>
            </select>
          </div>
        </div>
        <div class="signals-grid" id="stocks-signals"></div>
      </div>

      <div class="toolbar" style="justify-content: center; margin-top: 12px;">
        <span class="pill"><span class="dot" id="stocks-status-dot"></span><span id="stocks-status">Live</span></span>
        <span class="pill">üîÑ Last: <strong id="stocks-last-update">--</strong></span>
      </div>
    </section>

    <!-- Z-Score Chart Section -->
    <section class="section card" style="margin-top: 14px;">
      <div class="section-title">
        <span>üìà Z-Score Monitor</span>
        <small>Interactive</small>
      </div>

      <div class="toolbar" style="margin-bottom: 12px;">
        <select class="select" id="chart-market" onchange="updatePairOptions()">
          <option value="crypto">‚Çø Crypto</option>
          <option value="stocks">üìà Stocks</option>
        </select>

        <select class="select" id="chart-pair" onchange="loadZscoreChart()" style="min-width: 180px;">
          <option value="">Select a pair...</option>
        </select>

        <span class="pill" id="chart-current-z" style="font-family: var(--mono);">Current Z: --</span>
      </div>

      <div id="zscore-chart" style="width: 100%; height: 360px; background: rgba(0,0,0,0.18); border-radius: 18px;"></div>
    </section>

    <footer>
      <p>Paper Trading Simulation ‚Ä¢ Crypto: Cointegration + OLS ‚Ä¢ Stocks: Kalman Filter</p>
      <p>Not financial advice ‚Ä¢ Use at your own risk</p>
    </footer>
  </div>

  <script>
    let currentMarket = 'crypto';

    const marketState = {
      crypto: { portfolio: null, trades: [], signals: [] },
      stocks: { portfolio: null, trades: [], signals: [] },
    };

    function showToast(title, message, variant = 'info', ttlMs = 4500) {
      const stack = document.getElementById('toast-stack');
      const el = document.createElement('div');
      el.className = 'toast';

      const accent = variant === 'success' ? 'rgba(32,245,166,0.25)'
        : variant === 'error' ? 'rgba(255,77,103,0.25)'
        : variant === 'warn' ? 'rgba(255,204,102,0.25)'
        : 'rgba(90,166,255,0.25)';

      el.style.borderColor = accent;
      el.innerHTML = `
        <div>
          <div class="title">${escapeHtml(title)}</div>
          <div class="msg">${escapeHtml(message)}</div>
        </div>
        <button class="x" aria-label="Dismiss">‚úï</button>
      `;

      el.querySelector('.x').onclick = () => el.remove();
      stack.appendChild(el);

      window.setTimeout(() => {
        if (el.isConnected) el.remove();
      }, ttlMs);
    }

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, (c) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[c]));
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || Number.isNaN(Number(value))) return '--';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(value));
    }

    function formatPct(value) {
      if (value === null || value === undefined || Number.isNaN(Number(value))) return '--';
      const v = Number(value);
      return `${v >= 0 ? '+' : ''}${v.toFixed(2)}%`;
    }

    function formatDateTime(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return String(isoString);
      return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    }

    function formatTime(isoString) {
      if (!isoString) return '--';
      const d = new Date(isoString);
      if (Number.isNaN(d.getTime())) return String(isoString);
      return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function badgeForAction(action) {
      const a = String(action || '').toUpperCase();
      if (a.includes('BLOCK')) return '<span class="badge blocked">BLOCKED</span>';
      if (a.includes('BUY')) return '<span class="badge buy">BUY</span>';
      if (a.includes('SELL')) return '<span class="badge sell">SELL</span>';
      if (a.includes('HOLD')) return '<span class="badge hold">HOLD</span>';
      if (a.includes('CLOSE')) return '<span class="badge neutral">CLOSE</span>';
      if (a.includes('OPEN')) return '<span class="badge neutral">OPEN</span>';
      return '<span class="badge neutral">‚Äî</span>';
    }

    function zColor(z) {
      const v = Number(z);
      if (!Number.isFinite(v)) return 'var(--muted)';
      if (v >= 2) return 'var(--bad)';
      if (v <= -2) return 'var(--good)';
      return 'var(--text)';
    }

    function switchTab(market) {
      currentMarket = market;

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const tab = document.querySelector(`.tab[data-market="${market}"]`);
      if (tab) tab.classList.add('active');

      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      const section = document.getElementById(`content-${market}`);
      if (section) section.classList.add('active');

      document.getElementById('global-market').textContent = market.toUpperCase();
      document.getElementById('btn-refresh-pairs').style.display = market === 'stocks' ? 'inline-flex' : 'none';

      // update global meta from last loaded state
      const p = marketState[market]?.portfolio;
      if (p) updateGlobalMetaFromPortfolio(market, p);
    }

    async function loadSummary() {
      const res = await fetch('/api/summary');
      const data = await res.json();

      document.getElementById('crypto-value').textContent = formatCurrency(data.crypto.total_value);
      const cryptoPnl = document.getElementById('crypto-pnl');
      cryptoPnl.textContent = `${data.crypto.pnl >= 0 ? '+' : ''}${formatCurrency(data.crypto.pnl)} (${data.crypto.pnl_pct.toFixed(2)}%)`;
      cryptoPnl.className = `summary-pnl ${data.crypto.pnl >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('stocks-value').textContent = formatCurrency(data.stocks.total_value);
      const stocksPnl = document.getElementById('stocks-pnl');
      stocksPnl.textContent = `${data.stocks.pnl >= 0 ? '+' : ''}${formatCurrency(data.stocks.pnl)} (${data.stocks.pnl_pct.toFixed(2)}%)`;
      stocksPnl.className = `summary-pnl ${data.stocks.pnl >= 0 ? 'positive' : 'negative'}`;

      document.getElementById('combined-value').textContent = formatCurrency(data.combined.total_value);
      const combinedPnl = document.getElementById('combined-pnl');
      const combinedPnlPct = (data.combined.pnl / data.combined.initial) * 100;
      combinedPnl.textContent = `${data.combined.pnl >= 0 ? '+' : ''}${formatCurrency(data.combined.pnl)} (${combinedPnlPct.toFixed(2)}%)`;
      combinedPnl.className = `summary-pnl ${data.combined.pnl >= 0 ? 'positive' : 'negative'}`;
    }

    function updateGlobalMetaFromPortfolio(market, portfolio) {
      const dot = document.getElementById('global-status-dot');
      const statusText = document.getElementById('global-status-text');
      const last = document.getElementById('global-last-update');

      if (portfolio?.is_stale) {
        dot.classList.add('stale');
        statusText.textContent = 'STALE';
      } else {
        dot.classList.remove('stale');
        statusText.textContent = 'Live';
      }

      last.textContent = formatTime(portfolio?.last_update);

      // Banner
      const banner = document.getElementById('health-banner');
      const staleTimeEl = document.getElementById('stale-time');
      if (portfolio?.is_stale && portfolio?.seconds_since_update !== undefined) {
        banner.classList.add('show');
        const secs = Number(portfolio.seconds_since_update);
        const mins = Math.floor(secs / 60);
        staleTimeEl.textContent = mins > 0 ? `${mins}m` : `${Math.floor(secs)}s`;
      } else {
        banner.classList.remove('show');
      }
    }

    function renderPositions(market) {
      const prefix = market;
      const positionsEl = document.getElementById(`${prefix}-positions`);
      const countEl = document.getElementById(`${prefix}-positions-count`);

      const portfolio = marketState[market]?.portfolio;
      const signals = marketState[market]?.signals || [];
      const signalsByPair = new Map(signals.map(s => [s.pair, s]));

      const positions = portfolio?.positions || {};
      const entries = Object.entries(positions);
      if (countEl) countEl.textContent = String(entries.length);

      if (entries.length === 0) {
        positionsEl.innerHTML = '<div class="empty-state">No open positions</div>';
        return;
      }

      positionsEl.innerHTML = entries.map(([pair, pos]) => {
        const sig = signalsByPair.get(pair);
        const zNow = sig?.zscore;
        const upnl = pos?.unrealized_pnl;
        const upnlPct = pos?.unrealized_pnl_pct;
        const actionBadge = badgeForAction(pos?.type || sig?.action);

        const pnlStr = (upnl !== undefined && upnl !== null)
          ? `${Number(upnl) >= 0 ? '+' : ''}${formatCurrency(upnl)} (${formatPct(upnlPct)})`
          : '--';

        const rightTop = (upnl !== undefined && upnl !== null)
          ? `<div class="item-value ${Number(upnl) >= 0 ? 'positive' : 'negative'}">${pnlStr}</div>`
          : `<div class="item-value">${formatCurrency(pos?.position_value)}</div>`;

        return `
          <div class="list-item">
            <div>
              <div class="item-pair">${escapeHtml(pair)}</div>
              <div class="subtext">
                ${actionBadge}
                <span style="margin-left: 8px;">Entry Z: <span style="font-family: var(--mono);">${Number(pos?.entry_zscore ?? 0).toFixed(2)}</span></span>
                ${zNow !== undefined ? `<span style="margin-left: 8px;">Now Z: <span style="font-family: var(--mono); color: ${zColor(zNow)};">${Number(zNow).toFixed(2)}</span></span>` : ''}
              </div>
            </div>
            <div style="min-width: 180px;">
              ${rightTop}
              <div class="subtext">Size: ${formatCurrency(pos?.position_value)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderSignals(market) {
      const prefix = market;
      const signalsEl = document.getElementById(`${prefix}-signals`);
      const signals = marketState[market]?.signals || [];

      const q = String(document.getElementById(`${prefix}-signal-search`)?.value || '').trim().toUpperCase();
      const sortMode = String(document.getElementById(`${prefix}-signal-sort`)?.value || 'absz');

      let filtered = signals;
      if (q) filtered = filtered.filter(s => String(s.pair || '').toUpperCase().includes(q));

      filtered = [...filtered].sort((a, b) => {
        if (sortMode === 'pair') return String(a.pair).localeCompare(String(b.pair));
        if (sortMode === 'action') return String(a.action).localeCompare(String(b.action));
        // absz default
        return Math.abs(Number(b.zscore)) - Math.abs(Number(a.zscore));
      });

      if (filtered.length === 0) {
        signalsEl.innerHTML = '<div class="empty-state">No signals match your filter.</div>';
        return;
      }

      signalsEl.innerHTML = filtered.map(sig => {
        const pair = escapeHtml(sig.pair);
        const method = escapeHtml(sig.method || '‚Äî');
        const action = escapeHtml(sig.action || 'NO_SIGNAL');
        const z = Number(sig.zscore);
        const zStr = Number.isFinite(z) ? z.toFixed(2) : '--';

        const extra = [];
        if (sig.cluster) extra.push(escapeHtml(sig.cluster));
        if (sig.edge_prob !== undefined && sig.edge_prob !== null) extra.push(`edge=${Number(sig.edge_prob).toFixed(2)}`);

        return `
          <div class="signal-card" onclick="selectPairForChart('${market}', '${sig.pair}')" title="Click to open in Z-Score chart">
            <div class="signal-head">
              <div>
                <div class="signal-pair">${pair}</div>
                <div class="signal-method">${method}${extra.length ? ` ‚Ä¢ ${extra.join(' ‚Ä¢ ')}` : ''}</div>
              </div>
              ${badgeForAction(action)}
            </div>
            <div class="signal-zscore" style="color: ${zColor(z)};">${zStr}</div>
            <div class="signal-foot">
              <div class="subtext">${escapeHtml(action)}</div>
              <div class="subtext" style="font-family: var(--mono);">|Z|=${Number.isFinite(z) ? Math.abs(z).toFixed(2) : '--'}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTrades(market) {
      const prefix = market;
      const tradesEl = document.getElementById(`${prefix}-trades-list`);

      const trades = marketState[market]?.trades || [];
      const sorted = [...trades].sort((a, b) => new Date(a.time) - new Date(b.time));
      const closed = sorted.filter(t => String(t.action || '').toUpperCase() === 'CLOSE');

      const display = (closed.length > 0 ? closed : sorted).slice(-5).reverse();
      const header = closed.length > 0
        ? ''
        : '<div class="empty-state" style="margin-bottom: 10px;">No completed trades yet ‚Äî showing latest trade activity</div>';

      if (display.length === 0) {
        tradesEl.innerHTML = '<div class="empty-state">No trades yet</div>';
        return;
      }

      tradesEl.innerHTML = header + display.map(t => {
        const pnl = t.pnl;
        const pnlClass = pnl !== null && pnl !== undefined ? (Number(pnl) >= 0 ? 'positive' : 'negative') : '';
        const pnlText = pnl !== null && pnl !== undefined ? `${Number(pnl) >= 0 ? '+' : ''}${formatCurrency(pnl)}` : '--';
        const action = t.action || t.type || t.trade_type || '‚Äî';

        return `
          <div class="list-item">
            <div>
              <div class="item-pair">${escapeHtml(t.pair || '')}</div>
              <div class="subtext">${formatDateTime(t.time)} ‚Ä¢ ${badgeForAction(action)} <span style="margin-left: 8px;">${escapeHtml(String(action))}</span></div>
            </div>
            <div class="item-value ${pnlClass}">${pnlText}</div>
          </div>
        `;
      }).join('');
    }

    function updatePairOptions() {
      const market = document.getElementById('chart-market').value;
      const pairSelect = document.getElementById('chart-pair');

      const pairs = new Set();
      const signals = marketState[market]?.signals || [];
      const trades = marketState[market]?.trades || [];
      const positions = marketState[market]?.portfolio?.positions || {};

      signals.forEach(s => pairs.add(s.pair));
      trades.forEach(t => pairs.add(t.pair));
      Object.keys(positions).forEach(p => pairs.add(p));

      const list = Array.from(pairs).filter(Boolean).sort();

      const current = pairSelect.value;
      pairSelect.innerHTML = '<option value="">Select a pair...</option>';
      list.forEach(pair => {
        const opt = document.createElement('option');
        opt.value = pair;
        opt.textContent = pair;
        pairSelect.appendChild(opt);
      });

      if (current && list.includes(current)) {
        pairSelect.value = current;
      }
    }

    function selectPairForChart(market, pair) {
      const marketSel = document.getElementById('chart-market');
      marketSel.value = market;
      updatePairOptions();

      const pairSel = document.getElementById('chart-pair');
      pairSel.value = pair;
      loadZscoreChart();

      // Smooth scroll to chart
      document.getElementById('zscore-chart').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    async function loadMarketData(market) {
      const res = await fetch(`/api/portfolio/${market}`);
      const data = await res.json();

      marketState[market].portfolio = data;
      marketState[market].signals = data.signals || [];

      const prefix = market;

      // Metrics
      document.getElementById(`${prefix}-total`).textContent = formatCurrency(data.total_value);
      document.getElementById(`${prefix}-cash`).textContent = formatCurrency(data.cash);

      const pnlEl = document.getElementById(`${prefix}-pnl-detail`);
      pnlEl.textContent = `${data.pnl >= 0 ? '+' : ''}${formatCurrency(data.pnl)} (${data.pnl_pct.toFixed(2)}%)`;
      pnlEl.className = `metric-value ${data.pnl >= 0 ? 'positive' : 'negative'}`;

      document.getElementById(`${prefix}-winrate`).textContent = `${data.win_rate.toFixed(1)}%`;
      document.getElementById(`${prefix}-trades`).textContent = data.closed_trades;

      // Status pills
      const statusDot = document.getElementById(`${prefix}-status-dot`);
      const statusText = document.getElementById(`${prefix}-status`);
      if (data.is_stale) {
        statusDot.classList.add('stale');
        statusText.textContent = 'STALE';
      } else {
        statusDot.classList.remove('stale');
        statusText.textContent = 'Live';
      }
      document.getElementById(`${prefix}-last-update`).textContent = formatTime(data.last_update);

      // Global meta uses the active tab portfolio
      if (market === currentMarket) {
        updateGlobalMetaFromPortfolio(market, data);
      }

      // Positions, Signals
      renderPositions(market);
      renderSignals(market);

      // Trades
      const tradesRes = await fetch(`/api/trades/${market}`);
      const trades = await tradesRes.json();
      marketState[market].trades = trades || [];
      renderTrades(market);

      // Chart pairs
      updatePairOptions();
    }

    async function loadAllData() {
      try {
        await loadSummary();
        await loadMarketData('crypto');
        await loadMarketData('stocks');
      } catch (e) {
        showToast('Dashboard error', String(e), 'error');
      }
    }

    async function forceUpdate() {
      const btn = document.getElementById('btn-force');
      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = 'Updating‚Ä¶';

      try {
        await fetch(`/api/update/${currentMarket}`);
        await loadAllData();
        showToast('Update complete', `${currentMarket.toUpperCase()} refreshed`, 'success');
      } catch (e) {
        showToast('Update failed', String(e), 'error');
      } finally {
        btn.textContent = prev;
        btn.disabled = false;
      }
    }

    async function resetPortfolio() {
      if (!confirm(`Reset ${currentMarket.toUpperCase()} portfolio? All trades will be lost.`)) return;

      const btn = document.getElementById('btn-reset');
      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = 'Resetting‚Ä¶';

      try {
        await fetch(`/api/reset/${currentMarket}`);
        await loadAllData();
        showToast('Portfolio reset', `${currentMarket.toUpperCase()} cleared`, 'warn');
      } catch (e) {
        showToast('Reset failed', String(e), 'error');
      } finally {
        btn.textContent = prev;
        btn.disabled = false;
      }
    }

    async function refreshPairs() {
      try {
        showToast('Refreshing pairs', 'Running pair finder in background‚Ä¶', 'info', 5000);
        const res = await fetch('/api/pairs/refresh', { method: 'POST' });
        const data = await res.json();
        if (data.error) {
          showToast('Pair refresh failed', data.error, 'error');
        } else {
          showToast('Pair refresh started', data.message || 'Check /api/pairs for status', 'success', 6000);
        }
      } catch (e) {
        showToast('Pair refresh failed', String(e), 'error');
      }
    }

    async function loadZscoreChart() {
      const market = document.getElementById('chart-market').value;
      const pair = document.getElementById('chart-pair').value;

      if (!pair) {
        Plotly.newPlot('zscore-chart', [], {
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: 'rgba(255,255,255,0.55)' },
          margin: { t: 20, r: 20, b: 45, l: 45 },
          xaxis: { gridcolor: 'rgba(255,255,255,0.08)' },
          yaxis: { gridcolor: 'rgba(255,255,255,0.08)', range: [-4, 4] }
        }, { responsive: true });
        document.getElementById('chart-current-z').textContent = 'Current Z: --';
        return;
      }

      document.getElementById('chart-current-z').textContent = 'Loading‚Ä¶';

      try {
        const res = await fetch(`/api/zscore_history/${market}/${pair}`);
        const data = await res.json();
        if (data.error) {
          showToast('Chart error', data.error, 'error');
          return;
        }

        const dates = data.data.map(d => d.date);
        const zscores = data.data.map(d => d.zscore);
        const entry = (data.entry_threshold !== undefined && data.entry_threshold !== null) ? data.entry_threshold : 2;

        const zscore_trace = {
          x: dates,
          y: zscores,
          type: 'scatter',
          mode: 'lines',
          name: 'Z-Score',
          line: { color: '#5aa6ff', width: 2 },
        };

        const upper_threshold = {
          x: dates,
          y: dates.map(() => entry),
          type: 'scatter',
          mode: 'lines',
          name: `SELL (+${entry})`,
          line: { color: '#ff4d67', width: 2, dash: 'dash' },
        };

        const lower_threshold = {
          x: dates,
          y: dates.map(() => -entry),
          type: 'scatter',
          mode: 'lines',
          name: `BUY (-${entry})`,
          line: { color: '#20f5a6', width: 2, dash: 'dash' },
        };

        const zero_line = {
          x: dates,
          y: dates.map(() => 0),
          type: 'scatter',
          mode: 'lines',
          name: 'Mean',
          line: { color: 'rgba(255,255,255,0.35)', width: 1, dash: 'dot' },
        };

        const layout = {
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          font: { color: 'rgba(255,255,255,0.85)', family: 'Outfit, sans-serif' },
          margin: { t: 20, r: 20, b: 45, l: 45 },
          xaxis: { gridcolor: 'rgba(255,255,255,0.08)', tickangle: -30 },
          yaxis: { gridcolor: 'rgba(255,255,255,0.08)', range: [-4, 4], title: 'Z-Score' },
          legend: { orientation: 'h', y: -0.2 },
          showlegend: true,
        };

        Plotly.newPlot('zscore-chart', [zscore_trace, upper_threshold, lower_threshold, zero_line], layout, { responsive: true });

        const currentZ = data.current_zscore;
        const el = document.getElementById('chart-current-z');
        el.textContent = `Current Z: ${Number(currentZ).toFixed(2)}`;
        el.style.color = currentZ > entry ? 'var(--bad)' : (currentZ < -entry ? 'var(--good)' : 'var(--text)');

      } catch (e) {
        showToast('Chart error', String(e), 'error');
      }
    }

    // Boot
    document.getElementById('btn-refresh-pairs').style.display = 'none';
    updatePairOptions();
    loadAllData();
    setInterval(loadAllData, 30000);
  </script>
</body>
</html>
