<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Unified Trading Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0d0d12;
            --bg-card: #16161f;
            --bg-hover: #1e1e2a;
            --accent-crypto: #f7931a;
            --accent-stocks: #00d4aa;
            --accent-red: #ff4757;
            --accent-green: #00ff88;
            --accent-blue: #4da6ff;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --border: #2a2a3a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 30px 0 20px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 25px 0;
        }

        .tab {
            padding: 14px 35px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background: var(--bg-card);
        }

        .tab:hover {
            background: var(--bg-hover);
        }

        .tab.active.crypto {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.2), rgba(247, 147, 26, 0.1));
            border-color: var(--accent-crypto);
            color: var(--accent-crypto);
        }

        .tab.active.stocks {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.2), rgba(0, 212, 170, 0.1));
            border-color: var(--accent-stocks);
            color: var(--accent-stocks);
        }

        .tab-icon { margin-right: 8px; }

        /* Combined Summary */
        .summary-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .summary-card.crypto { border-left: 3px solid var(--accent-crypto); }
        .summary-card.stocks { border-left: 3px solid var(--accent-stocks); }
        .summary-card.combined { border-left: 3px solid var(--accent-blue); }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .summary-pnl {
            font-size: 0.9rem;
            margin-top: 3px;
        }

        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }

        /* Content Sections */
        .content { display: none; }
        .content.active { display: block; }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.6rem;
            font-weight: 700;
            margin-top: 8px;
        }

        /* Two Column Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Signals Grid */
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        .signal-card {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .signal-pair {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .signal-method {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .signal-zscore {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .signal-action {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
            display: inline-block;
        }

        .action-buy { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .action-sell { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }
        .action-hold { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .action-none { background: rgba(139, 139, 158, 0.2); color: var(--text-secondary); }

        /* Positions & Trades */
        .list-item {
            background: var(--bg-dark);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-pair {
            font-weight: 600;
        }

        .item-type {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .type-buy { background: rgba(0, 255, 136, 0.2); color: var(--accent-green); }
        .type-sell { background: rgba(255, 71, 87, 0.2); color: var(--accent-red); }

        .item-value {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
        }

        /* Buttons */
        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), #6366f1);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #ff6b6b);
            color: white;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            display: inline-block;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        .status-dot.stale {
            background: var(--accent-red);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Health Banner */
        .health-banner {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid var(--accent-red);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
            color: var(--accent-red);
        }

        .health-banner.show { display: block; }

        /* Responsive */
        @media (max-width: 900px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
            .summary-bar { grid-template-columns: 1fr; }
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <div class="container">
        <header>
            <h1>üöÄ Unified Trading Dashboard</h1>
            <p class="subtitle">Crypto (Cointegration) + Stocks (Kalman Filter) Paper Trading</p>
        </header>

        <!-- Combined Summary -->
        <div class="summary-bar">
            <div class="summary-card crypto">
                <div class="summary-label">‚Çø Crypto Portfolio</div>
                <div class="summary-value" id="crypto-value">$10,000</div>
                <div class="summary-pnl" id="crypto-pnl">+$0.00 (0.00%)</div>
            </div>
            <div class="summary-card stocks">
                <div class="summary-label">üìà Stocks Portfolio</div>
                <div class="summary-value" id="stocks-value">$10,000</div>
                <div class="summary-pnl" id="stocks-pnl">+$0.00 (0.00%)</div>
            </div>
            <div class="summary-card combined">
                <div class="summary-label">üí∞ Combined Total</div>
                <div class="summary-value" id="combined-value">$20,000</div>
                <div class="summary-pnl" id="combined-pnl">+$0.00 (0.00%)</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab active crypto" data-market="crypto" onclick="switchTab('crypto')">
                <span class="tab-icon">‚Çø</span>Crypto
            </div>
            <div class="tab stocks" data-market="stocks" onclick="switchTab('stocks')">
                <span class="tab-icon">üìà</span>Stocks
            </div>
        </div>

        <!-- Health Banner -->
        <div class="health-banner" id="health-banner">
            ‚ö†Ô∏è Data is STALE! Last update was <span id="stale-time">--</span> ago.
        </div>

        <!-- Crypto Content -->
        <div class="content active" id="content-crypto">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">üí∞ Portfolio Value</div>
                    <div class="metric-value" id="crypto-total">$10,000</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üìä P&L</div>
                    <div class="metric-value" id="crypto-pnl-detail">$0.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üéØ Win Rate</div>
                    <div class="metric-value" id="crypto-winrate">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üìà Trades</div>
                    <div class="metric-value" id="crypto-trades">0</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="section">
                    <h3 class="section-title">üìç Open Positions</h3>
                    <div id="crypto-positions"><div class="empty-state">No open positions</div></div>
                </div>
                <div class="section">
                    <h3 class="section-title">üìú Recent Trades</h3>
                    <div id="crypto-trades-list"><div class="empty-state">No trades yet</div></div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üì° Live Signals (OLS Z-Score)</h3>
                <div class="signals-grid" id="crypto-signals"></div>
            </div>

            <div class="status-bar">
                <span><span class="status-dot" id="crypto-status-dot"></span><span id="crypto-status">Live</span></span>
                <span>üîÑ Last: <span id="crypto-last-update">--</span></span>
            </div>
        </div>

        <!-- Stocks Content -->
        <div class="content" id="content-stocks">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">üí∞ Portfolio Value</div>
                    <div class="metric-value" id="stocks-total">$10,000</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üìä P&L</div>
                    <div class="metric-value" id="stocks-pnl-detail">$0.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üéØ Win Rate</div>
                    <div class="metric-value" id="stocks-winrate">0%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">üìà Trades</div>
                    <div class="metric-value" id="stocks-trades">0</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="section">
                    <h3 class="section-title">üìç Open Positions</h3>
                    <div id="stocks-positions"><div class="empty-state">No open positions</div></div>
                </div>
                <div class="section">
                    <h3 class="section-title">üìú Recent Trades</h3>
                    <div id="stocks-trades-list"><div class="empty-state">No trades yet</div></div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">üì° Live Signals (Kalman Filter)</h3>
                <div class="signals-grid" id="stocks-signals"></div>
            </div>

            <div class="status-bar">
                <span><span class="status-dot" id="stocks-status-dot"></span><span id="stocks-status">Live</span></span>
                <span>üîÑ Last: <span id="stocks-last-update">--</span></span>
            </div>
        </div>

        <!-- Z-Score Chart Section -->
        <div class="section" style="margin-top: 25px;">
            <h3 class="section-title">üìà Z-Score Monitor</h3>
            <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                <select id="chart-market" onchange="updatePairOptions()" style="padding: 10px 15px; border-radius: 8px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); cursor: pointer;">
                    <option value="crypto">‚Çø Crypto</option>
                    <option value="stocks">üìà Stocks</option>
                </select>
                <select id="chart-pair" onchange="loadZscoreChart()" style="padding: 10px 15px; border-radius: 8px; background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); cursor: pointer; min-width: 150px;">
                    <option value="">Select a pair...</option>
                </select>
                <span id="chart-current-z" style="padding: 10px 15px; background: var(--bg-dark); border-radius: 8px; font-family: 'JetBrains Mono', monospace;">Current Z: --</span>
            </div>
            <div id="zscore-chart" style="width: 100%; height: 350px; background: var(--bg-dark); border-radius: 12px;"></div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="forceUpdate()">üîÑ Force Update</button>
            <button class="btn btn-danger" onclick="resetPortfolio()">üóëÔ∏è Reset Portfolio</button>
        </div>

        <footer>
            <p>Paper Trading Simulation ‚Ä¢ Crypto: Cointegration + OLS ‚Ä¢ Stocks: Spectral Clustering + Kalman Filter</p>
            <p>Updates every 5 minutes ‚Ä¢ Not real money</p>
        </footer>
    </div>

    <script>
        let currentMarket = 'crypto';

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }

        function formatTime(isoString) {
            if (!isoString) return '--';
            return new Date(isoString).toLocaleTimeString();
        }

        function getZscoreClass(z) {
            if (z > 2) return 'negative';
            if (z < -2) return 'positive';
            return '';
        }

        function getActionClass(action) {
            if (action.includes('BUY')) return 'action-buy';
            if (action.includes('SELL')) return 'action-sell';
            if (action.includes('HOLD')) return 'action-hold';
            return 'action-none';
        }

        function switchTab(market) {
            currentMarket = market;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-market="${market}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById(`content-${market}`).classList.add('active');
        }

        async function loadSummary() {
            const res = await fetch('/api/summary');
            const data = await res.json();

            // Crypto
            document.getElementById('crypto-value').textContent = formatCurrency(data.crypto.total_value);
            const cryptoPnl = document.getElementById('crypto-pnl');
            cryptoPnl.textContent = `${data.crypto.pnl >= 0 ? '+' : ''}${formatCurrency(data.crypto.pnl)} (${data.crypto.pnl_pct.toFixed(2)}%)`;
            cryptoPnl.className = `summary-pnl ${data.crypto.pnl >= 0 ? 'positive' : 'negative'}`;

            // Stocks
            document.getElementById('stocks-value').textContent = formatCurrency(data.stocks.total_value);
            const stocksPnl = document.getElementById('stocks-pnl');
            stocksPnl.textContent = `${data.stocks.pnl >= 0 ? '+' : ''}${formatCurrency(data.stocks.pnl)} (${data.stocks.pnl_pct.toFixed(2)}%)`;
            stocksPnl.className = `summary-pnl ${data.stocks.pnl >= 0 ? 'positive' : 'negative'}`;

            // Combined
            document.getElementById('combined-value').textContent = formatCurrency(data.combined.total_value);
            const combinedPnl = document.getElementById('combined-pnl');
            const combinedPnlPct = (data.combined.pnl / data.combined.initial) * 100;
            combinedPnl.textContent = `${data.combined.pnl >= 0 ? '+' : ''}${formatCurrency(data.combined.pnl)} (${combinedPnlPct.toFixed(2)}%)`;
            combinedPnl.className = `summary-pnl ${data.combined.pnl >= 0 ? 'positive' : 'negative'}`;
        }

        async function loadMarketData(market) {
            const res = await fetch(`/api/portfolio/${market}`);
            const data = await res.json();

            const prefix = market;

            // Metrics
            document.getElementById(`${prefix}-total`).textContent = formatCurrency(data.total_value);
            const pnlEl = document.getElementById(`${prefix}-pnl-detail`);
            pnlEl.textContent = `${data.pnl >= 0 ? '+' : ''}${formatCurrency(data.pnl)} (${data.pnl_pct.toFixed(2)}%)`;
            pnlEl.className = `metric-value ${data.pnl >= 0 ? 'positive' : 'negative'}`;
            document.getElementById(`${prefix}-winrate`).textContent = `${data.win_rate.toFixed(1)}%`;
            document.getElementById(`${prefix}-trades`).textContent = data.closed_trades;

            // Status
            const statusDot = document.getElementById(`${prefix}-status-dot`);
            const statusText = document.getElementById(`${prefix}-status`);
            if (data.is_stale) {
                statusDot.classList.add('stale');
                statusText.textContent = '‚ö†Ô∏è STALE';
            } else {
                statusDot.classList.remove('stale');
                statusText.textContent = 'Live';
            }
            document.getElementById(`${prefix}-last-update`).textContent = formatTime(data.last_update);

            // Positions
            const positionsEl = document.getElementById(`${prefix}-positions`);
            const positions = data.positions;
            if (Object.keys(positions).length === 0) {
                positionsEl.innerHTML = '<div class="empty-state">No open positions</div>';
            } else {
                positionsEl.innerHTML = Object.entries(positions).map(([pair, pos]) => `
                    <div class="list-item">
                        <div>
                            <div class="item-pair">${pair}</div>
                            <span class="item-type ${pos.type.includes('BUY') ? 'type-buy' : 'type-sell'}">${pos.type}</span>
                        </div>
                        <div class="item-value">
                            <div>Z: ${pos.entry_zscore.toFixed(2)}</div>
                            <div>${formatCurrency(pos.position_value)}</div>
                        </div>
                    </div>
                `).join('');
            }

            // Signals
            const signalsEl = document.getElementById(`${prefix}-signals`);
            const signals = data.signals || [];
            signalsEl.innerHTML = signals.map(sig => `
                <div class="signal-card">
                    <div class="signal-pair">${sig.pair}</div>
                    <div class="signal-method">${sig.method || 'OLS'}</div>
                    <div class="signal-zscore ${getZscoreClass(sig.zscore)}">${sig.zscore.toFixed(2)}</div>
                    <div class="signal-action ${getActionClass(sig.action)}">${sig.action}</div>
                </div>
            `).join('');

            // Load trades
            const tradesRes = await fetch(`/api/trades/${market}`);
            const trades = await tradesRes.json();
            const tradesEl = document.getElementById(`${prefix}-trades-list`);
            const closedTrades = trades.filter(t => t.action === 'CLOSE').slice(-5).reverse();
            
            if (closedTrades.length === 0) {
                tradesEl.innerHTML = '<div class="empty-state">No completed trades yet</div>';
            } else {
                tradesEl.innerHTML = closedTrades.map(t => `
                    <div class="list-item">
                        <div>
                            <div class="item-pair">${t.pair}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${formatTime(t.time)}</div>
                        </div>
                        <div class="item-value ${t.pnl >= 0 ? 'positive' : 'negative'}">
                            ${t.pnl >= 0 ? '+' : ''}${formatCurrency(t.pnl)}
                        </div>
                    </div>
                `).join('');
            }
        }

        async function loadAllData() {
            await loadSummary();
            await loadMarketData('crypto');
            await loadMarketData('stocks');
        }

        async function forceUpdate() {
            await fetch(`/api/update/${currentMarket}`);
            await loadAllData();
        }

        async function resetPortfolio() {
            if (confirm(`Reset ${currentMarket.toUpperCase()} portfolio? All trades will be lost.`)) {
                await fetch(`/api/reset/${currentMarket}`);
                await loadAllData();
            }
        }

        // Pair options for chart
        const cryptoPairs = ['ETC-BCH', 'SHIB-BCH', 'XRP-XLM', 'LTC-XLM', 'ETC-XLM', 'SHIB-XLM', 'ETC-AAVE', 'SHIB-AAVE'];
        const stockPairs = ['MA-V', 'HD-LOW', 'COP-EOG', 'GS-JPM', 'CVX-XOM', 'DUK-SO', 'LMT-NOC', 'KO-PEP', 'GOOGL-META', 'AAPL-MSFT'];

        function updatePairOptions() {
            const market = document.getElementById('chart-market').value;
            const pairSelect = document.getElementById('chart-pair');
            const pairs = market === 'crypto' ? cryptoPairs : stockPairs;
            
            pairSelect.innerHTML = '<option value="">Select a pair...</option>';
            pairs.forEach(pair => {
                pairSelect.innerHTML += `<option value="${pair}">${pair}</option>`;
            });
        }

        async function loadZscoreChart() {
            const market = document.getElementById('chart-market').value;
            const pair = document.getElementById('chart-pair').value;
            
            if (!pair) {
                // Show empty chart
                Plotly.newPlot('zscore-chart', [], {
                    paper_bgcolor: '#0d0d12',
                    plot_bgcolor: '#0d0d12',
                    font: { color: '#8b8b9e' },
                    margin: { t: 30, r: 30, b: 50, l: 50 },
                    xaxis: { gridcolor: '#2a2a3a' },
                    yaxis: { gridcolor: '#2a2a3a', range: [-4, 4] }
                });
                return;
            }

            document.getElementById('chart-current-z').textContent = 'Loading...';

            try {
                const res = await fetch(`/api/zscore_history/${market}/${pair}`);
                const data = await res.json();

                if (data.error) {
                    console.error(data.error);
                    return;
                }

                const dates = data.data.map(d => d.date);
                const zscores = data.data.map(d => d.zscore);

                // Z-score line
                const zscore_trace = {
                    x: dates,
                    y: zscores,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Z-Score',
                    line: { color: '#4da6ff', width: 2 }
                };

                // +2 threshold line (SELL)
                const upper_threshold = {
                    x: dates,
                    y: dates.map(() => 2),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'SELL (+2)',
                    line: { color: '#ff4757', width: 2, dash: 'dash' }
                };

                // -2 threshold line (BUY)
                const lower_threshold = {
                    x: dates,
                    y: dates.map(() => -2),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'BUY (-2)',
                    line: { color: '#00ff88', width: 2, dash: 'dash' }
                };

                // Zero line
                const zero_line = {
                    x: dates,
                    y: dates.map(() => 0),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Mean',
                    line: { color: '#8b8b9e', width: 1, dash: 'dot' }
                };

                const layout = {
                    paper_bgcolor: '#0d0d12',
                    plot_bgcolor: '#16161f',
                    font: { color: '#ffffff', family: 'Outfit, sans-serif' },
                    margin: { t: 30, r: 30, b: 50, l: 50 },
                    xaxis: { 
                        gridcolor: '#2a2a3a',
                        tickangle: -45
                    },
                    yaxis: { 
                        gridcolor: '#2a2a3a',
                        range: [-4, 4],
                        title: 'Z-Score'
                    },
                    legend: {
                        orientation: 'h',
                        y: -0.2
                    },
                    showlegend: true
                };

                Plotly.newPlot('zscore-chart', [zscore_trace, upper_threshold, lower_threshold, zero_line], layout, {responsive: true});

                // Update current z-score display
                const currentZ = data.current_zscore;
                const zEl = document.getElementById('chart-current-z');
                zEl.textContent = `Current Z: ${currentZ.toFixed(2)}`;
                if (currentZ > 2) {
                    zEl.style.color = '#ff4757';
                } else if (currentZ < -2) {
                    zEl.style.color = '#00ff88';
                } else {
                    zEl.style.color = '#4da6ff';
                }

            } catch (error) {
                console.error('Error loading z-score chart:', error);
            }
        }

        // Initialize chart pair options
        updatePairOptions();

        // Initial load
        loadAllData();

        // Auto-refresh
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>

